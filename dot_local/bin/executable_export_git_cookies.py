#!/usr/bin/env python3
"""
export_git_cookies.py

Exports decrypted cookies from Brave/Chrome into Netscape cookie file format
suitable for `git config --global http.cookiefile ~/.gitcookies`.

Dependencies:
    pip install browser-cookie3

Usage:
    python export_git_cookies.py [--browser brave|chrome] [--domain mygit.com] [--out ~/.gitcookies]
    
Example:    
    pipx run --spec browser-cookie3 python ./bin/export_git_cookies.py --browser brave --domain my.git.com

If --domain is omitted, all cookies are exported.
"""

import argparse
import getpass
import os
import sys

try:
    import browser_cookie3 as bc3
except Exception as e:
    print("This script requires the 'browser-cookie3' package.")
    print("Install it with:   pip install browser-cookie3")
    print("Error:", e)
    sys.exit(1)


def cookiejar_for_browser(browser_name: str):
    """Return a cookiejar object for the requested browser (brave or chrome)."""
    browser_name = browser_name.lower()
    if browser_name == "brave":
        return bc3.brave()
    elif browser_name == "chrome":
        return bc3.chrome()
    else:
        raise ValueError("Unsupported browser: choose 'brave' or 'chrome'.")


def domain_matches(cookie_domain: str, target: str) -> bool:
    """Return True if cookie_domain matches target domain.
    This allows cookies like '.example.com' to match 'example.com' and subdomains.
    """
    if not target:
        return True
    c = cookie_domain.lstrip(".").lower()
    t = target.lower()
    return c == t or c.endswith("." + t)


def write_netscape_cookiefile(cookiejar, outpath: str, target_domain: str | None):
    """Write cookies in Netscape format:
       domain  include_subdomains  path  secure  expires  name  value
    """
    lines = []
    count = 0
    for c in cookiejar:
        # cookie attributes come from cookiejar.Cookie
        domain = c.domain or ""
        if not domain_matches(domain, target_domain):
            continue

        include_subdomains = "TRUE" if domain.startswith(".") else "FALSE"
        path = c.path or "/"
        secure_flag = "TRUE" if getattr(c, "secure", False) else "FALSE"
        # expires may be None; set to 0 if so
        expires = int(getattr(c, "expires", 0) or 0)
        name = c.name or ""
        value = c.value or ""

        # Ensure no tabs/newlines inside fields (escape minimally)
        name = name.replace("\t", "%09").replace("\n", "%0A").replace("\r", "")
        value = value.replace("\t", "%09").replace("\n", "%0A").replace("\r", "")

        line = f"{domain}\t{include_subdomains}\t{path}\t{secure_flag}\t{expires}\t{name}\t{value}"
        lines.append(line)
        count += 1

    # write atomically
    tmp_path = outpath + ".tmp"
    with open(tmp_path, "w", encoding="utf-8") as f:
        f.write("# Netscape cookie file generated by export_git_cookies.py\n")
        f.write("# User: {}\n".format(getpass.getuser()))
        f.write("\n".join(lines))
        f.write("\n")
    os.replace(tmp_path, outpath)
    # set permissions to 600
    try:
        os.chmod(outpath, 0o600)
    except Exception:
        # If chmod fails (Windows etc.), ignore
        pass
    return count


def main():
    parser = argparse.ArgumentParser(description="Export Brave/Chrome cookies to Netscape cookie file (for git).")
    parser.add_argument("--browser", choices=["brave", "chrome"], default="brave",
                        help="Which browser to read cookies from (default: brave).")
    parser.add_argument("--domain", default=None,
                        help="Target domain to export (e.g. mygit.com). If omitted, exports all cookies.")
    parser.add_argument("--out", default=os.path.expanduser("~/.gitcookies"),
                        help="Output cookie file (default: ~/.gitcookies)")
    args = parser.parse_args()

    try:
        cj = cookiejar_for_browser(args.browser)
    except Exception as e:
        print("Failed to load cookies from browser:", e)
        sys.exit(1)

    print(f"Loaded cookies from {args.browser}. Filtering for domain: {args.domain or '<all>'}")
    count = write_netscape_cookiefile(cj, args.out, args.domain)
    print(f"Wrote {count} cookie(s) to {args.out}")
    print("File permissions set to 600 (if supported).")
    print("You can now run:\n  git config --global http.cookiefile {}".format(args.out))


if __name__ == "__main__":
    main()
